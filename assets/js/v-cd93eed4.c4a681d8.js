"use strict";(self.webpackChunkmyblog=self.webpackChunkmyblog||[]).push([[97096],{69504:(n,s,a)=>{a.r(s),a.d(s,{default:()=>o});var t=a(78e3);const p=[(0,t.uE)('<h1 id="optimize" tabindex="-1"><a class="header-anchor" href="#optimize" aria-hidden="true">#</a> optimize</h1><p>å½“æˆ‘ä»¬çš„æ¨¡æ¿ <code>template</code> ç»è¿‡ <code>parse</code> è¿‡ç¨‹åï¼Œä¼šè¾“å‡ºç”Ÿæˆ AST æ ‘ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å¯¹è¿™é¢—æ ‘åšä¼˜åŒ–ï¼Œ<code>optimize</code> çš„é€»è¾‘æ˜¯è¿œç®€å•äº <code>parse</code> çš„é€»è¾‘ï¼Œæ‰€ä»¥ç†è§£èµ·æ¥ä¼šè½»æ¾å¾ˆå¤šã€‚</p><p>ä¸ºä»€ä¹ˆè¦æœ‰ä¼˜åŒ–è¿‡ç¨‹ï¼Œå› ä¸ºæˆ‘ä»¬çŸ¥é“ Vue æ˜¯æ•°æ®é©±åŠ¨ï¼Œæ˜¯å“åº”å¼çš„ï¼Œä½†æ˜¯æˆ‘ä»¬çš„æ¨¡æ¿å¹¶ä¸æ˜¯æ‰€æœ‰æ•°æ®éƒ½æ˜¯å“åº”å¼çš„ï¼Œä¹Ÿæœ‰å¾ˆå¤šæ•°æ®æ˜¯é¦–æ¬¡æ¸²æŸ“åå°±æ°¸è¿œä¸ä¼šå˜åŒ–çš„ï¼Œé‚£ä¹ˆè¿™éƒ¨åˆ†æ•°æ®ç”Ÿæˆçš„ DOM ä¹Ÿä¸ä¼šå˜åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ <code>patch</code> çš„è¿‡ç¨‹è·³è¿‡å¯¹ä»–ä»¬çš„æ¯”å¯¹ã€‚</p><p>æ¥çœ‹ä¸€ä¸‹ <code>optimize</code> æ–¹æ³•çš„å®šä¹‰ï¼Œåœ¨ <code>src/compiler/optimizer.js</code> ä¸­ï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token doc-comment comment">/**\n * Goal of the optimizer: walk the generated template AST tree\n * and detect sub-trees that are purely static, i.e. parts of\n * the DOM that never needs to change.\n *\n * Once we detect these sub-trees, we can:\n *\n * 1. Hoist them into constants, so that we no longer need to\n *    create fresh nodes for them on each re-render;\n * 2. Completely skip them in the patching process.\n */</span>\n<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">optimize</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">root</span><span class="token operator">:</span> <span class="token operator">?</span>ASTElement<span class="token punctuation">,</span> <span class="token literal-property property">options</span><span class="token operator">:</span> CompilerOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>root<span class="token punctuation">)</span> <span class="token keyword">return</span>\n  isStaticKey <span class="token operator">=</span> <span class="token function">genStaticKeysCached</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>staticKeys <span class="token operator">||</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>\n  isPlatformReservedTag <span class="token operator">=</span> options<span class="token punctuation">.</span>isReservedTag <span class="token operator">||</span> no\n  <span class="token comment">// first pass: mark all non-static nodes.</span>\n  <span class="token function">markStatic</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span>\n  <span class="token comment">// second pass: mark static roots.</span>\n  <span class="token function">markStaticRoots</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">genStaticKeys</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">keys</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span><span class="token operator">:</span> Function <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token function">makeMap</span><span class="token punctuation">(</span>\n    <span class="token string">&#39;type,tag,attrsList,attrsMap,plain,parent,children,attrs&#39;</span> <span class="token operator">+</span>\n    <span class="token punctuation">(</span>keys <span class="token operator">?</span> <span class="token string">&#39;,&#39;</span> <span class="token operator">+</span> keys <span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>\n  <span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬åœ¨ç¼–è¯‘é˜¶æ®µå¯ä»¥æŠŠä¸€äº› AST èŠ‚ç‚¹ä¼˜åŒ–æˆé™æ€èŠ‚ç‚¹ï¼Œæ‰€ä»¥æ•´ä¸ª <code>optimize</code> çš„è¿‡ç¨‹å®é™…ä¸Šå°±å¹² 2 ä»¶äº‹æƒ…ï¼Œ<code>markStatic(root)</code> æ ‡è®°é™æ€èŠ‚ç‚¹ ï¼Œ<code>markStaticRoots(root, false)</code> æ ‡è®°é™æ€æ ¹ã€‚</p><h2 id="æ ‡è®°é™æ€èŠ‚ç‚¹" tabindex="-1"><a class="header-anchor" href="#æ ‡è®°é™æ€èŠ‚ç‚¹" aria-hidden="true">#</a> æ ‡è®°é™æ€èŠ‚ç‚¹</h2><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">markStatic</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">node</span><span class="token operator">:</span> ASTNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  node<span class="token punctuation">.</span>static <span class="token operator">=</span> <span class="token function">isStatic</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// do not make component slot content static. this avoids</span>\n    <span class="token comment">// 1. components not able to mutate slot nodes</span>\n    <span class="token comment">// 2. static slot content fails for hot-reloading</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>\n      <span class="token operator">!</span><span class="token function">isPlatformReservedTag</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>\n      node<span class="token punctuation">.</span>tag <span class="token operator">!==</span> <span class="token string">&#39;slot&#39;</span> <span class="token operator">&amp;&amp;</span>\n      node<span class="token punctuation">.</span>attrsMap<span class="token punctuation">[</span><span class="token string">&#39;inline-template&#39;</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span>\n    <span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> child <span class="token operator">=</span> node<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span>\n      <span class="token function">markStatic</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>child<span class="token punctuation">.</span>static<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        node<span class="token punctuation">.</span>static <span class="token operator">=</span> <span class="token boolean">false</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> l <span class="token operator">=</span> node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> block <span class="token operator">=</span> node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>block\n        <span class="token function">markStatic</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>block<span class="token punctuation">.</span>static<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          node<span class="token punctuation">.</span>static <span class="token operator">=</span> <span class="token boolean">false</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">isStatic</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">node</span><span class="token operator">:</span> ASTNode</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// expression</span>\n    <span class="token keyword">return</span> <span class="token boolean">false</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// text</span>\n    <span class="token keyword">return</span> <span class="token boolean">true</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>pre <span class="token operator">||</span> <span class="token punctuation">(</span>\n    <span class="token operator">!</span>node<span class="token punctuation">.</span>hasBindings <span class="token operator">&amp;&amp;</span> <span class="token comment">// no dynamic bindings</span>\n    <span class="token operator">!</span>node<span class="token punctuation">.</span>if <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>node<span class="token punctuation">.</span>for <span class="token operator">&amp;&amp;</span> <span class="token comment">// not v-if or v-for or v-else</span>\n    <span class="token operator">!</span><span class="token function">isBuiltInTag</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token comment">// not a built-in</span>\n    <span class="token function">isPlatformReservedTag</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token comment">// not a component</span>\n    <span class="token operator">!</span><span class="token function">isDirectChildOfTemplateFor</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>\n    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span>isStaticKey<span class="token punctuation">)</span>\n  <span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é¦–å…ˆæ‰§è¡Œ <code>node.static = isStatic(node)</code></p><p><code>isStatic</code> æ˜¯å¯¹ä¸€ä¸ª AST å…ƒç´ èŠ‚ç‚¹æ˜¯å¦æ˜¯é™æ€çš„åˆ¤æ–­ï¼Œå¦‚æœæ˜¯è¡¨è¾¾å¼ï¼Œå°±æ˜¯éé™æ€ï¼›å¦‚æœæ˜¯çº¯æ–‡æœ¬ï¼Œå°±æ˜¯é™æ€ï¼›å¯¹äºä¸€ä¸ªæ™®é€šå…ƒç´ ï¼Œå¦‚æœæœ‰ pre å±æ€§ï¼Œé‚£ä¹ˆå®ƒä½¿ç”¨äº† <code>v-pre</code> æŒ‡ä»¤ï¼Œæ˜¯é™æ€ï¼Œå¦åˆ™è¦åŒæ—¶æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼šæ²¡æœ‰ä½¿ç”¨ <code>v-if</code>ã€<code>v-for</code>ï¼Œæ²¡æœ‰ä½¿ç”¨å…¶å®ƒæŒ‡ä»¤ï¼ˆä¸åŒ…æ‹¬ <code>v-once</code>ï¼‰ï¼Œéå†…ç½®ç»„ä»¶ï¼Œæ˜¯å¹³å°ä¿ç•™çš„æ ‡ç­¾ï¼Œéå¸¦æœ‰ <code>v-for</code> çš„ <code>template</code> æ ‡ç­¾çš„ç›´æ¥å­èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹çš„æ‰€æœ‰å±æ€§çš„ <code>key</code> éƒ½æ»¡è¶³é™æ€ keyï¼›è¿™äº›éƒ½æ»¡è¶³åˆ™è¿™ä¸ª AST èŠ‚ç‚¹æ˜¯ä¸€ä¸ªé™æ€èŠ‚ç‚¹ã€‚</p><p>å¦‚æœè¿™ä¸ªèŠ‚ç‚¹æ˜¯ä¸€ä¸ªæ™®é€šå…ƒç´ ï¼Œåˆ™éå†å®ƒçš„æ‰€æœ‰ <code>children</code>ï¼Œé€’å½’æ‰§è¡Œ <code>markStatic</code>ã€‚å› ä¸ºæ‰€æœ‰çš„ <code>elseif</code> å’Œ <code>else</code> èŠ‚ç‚¹éƒ½ä¸åœ¨ <code>children</code> ä¸­ï¼Œ å¦‚æœèŠ‚ç‚¹çš„ <code>ifConditions</code> ä¸ä¸ºç©ºï¼Œåˆ™éå† <code>ifConditions</code> æ‹¿åˆ°æ‰€æœ‰æ¡ä»¶ä¸­çš„ <code>block</code>ï¼Œä¹Ÿå°±æ˜¯å®ƒä»¬å¯¹åº”çš„ AST èŠ‚ç‚¹ï¼Œé€’å½’æ‰§è¡Œ <code>markStatic</code>ã€‚åœ¨è¿™äº›é€’å½’è¿‡ç¨‹ä¸­ï¼Œä¸€æ—¦å­èŠ‚ç‚¹æœ‰ä¸æ˜¯ <code>static</code> çš„æƒ…å†µï¼Œåˆ™å®ƒçš„çˆ¶èŠ‚ç‚¹çš„ <code>static</code> å‡å˜æˆ falseã€‚</p><h2 id="æ ‡è®°é™æ€æ ¹" tabindex="-1"><a class="header-anchor" href="#æ ‡è®°é™æ€æ ¹" aria-hidden="true">#</a> æ ‡è®°é™æ€æ ¹</h2><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">markStaticRoots</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">node</span><span class="token operator">:</span> ASTNode<span class="token punctuation">,</span> <span class="token literal-property property">isInFor</span><span class="token operator">:</span> boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>static <span class="token operator">||</span> node<span class="token punctuation">.</span>once<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      node<span class="token punctuation">.</span>staticInFor <span class="token operator">=</span> isInFor\n    <span class="token punctuation">}</span>\n    <span class="token comment">// For a node to qualify as a static root, it should have children that</span>\n    <span class="token comment">// are not just static text. Otherwise the cost of hoisting out will</span>\n    <span class="token comment">// outweigh the benefits and it&#39;s better off to just always render it fresh.</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>static <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>\n      node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span>\n      node<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">3</span>\n    <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      node<span class="token punctuation">.</span>staticRoot <span class="token operator">=</span> <span class="token boolean">true</span>\n      <span class="token keyword">return</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      node<span class="token punctuation">.</span>staticRoot <span class="token operator">=</span> <span class="token boolean">false</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">markStaticRoots</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> isInFor <span class="token operator">||</span> <span class="token operator">!</span><span class="token operator">!</span>node<span class="token punctuation">.</span>for<span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> l <span class="token operator">=</span> node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">markStaticRoots</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>block<span class="token punctuation">,</span> isInFor<span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>markStaticRoots</code> ç¬¬äºŒä¸ªå‚æ•°æ˜¯ <code>isInFor</code>ï¼Œå¯¹äºå·²ç»æ˜¯ <code>static</code> çš„èŠ‚ç‚¹æˆ–è€…æ˜¯ <code>v-once</code> æŒ‡ä»¤çš„èŠ‚ç‚¹ï¼Œ<code>node.staticInFor = isInFor</code>ã€‚ æ¥ç€å°±æ˜¯å¯¹äº <code>staticRoot</code> çš„åˆ¤æ–­é€»è¾‘ï¼Œä»æ³¨é‡Šä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºæœ‰èµ„æ ¼æˆä¸º <code>staticRoot</code> çš„èŠ‚ç‚¹ï¼Œé™¤äº†æœ¬èº«æ˜¯ä¸€ä¸ªé™æ€èŠ‚ç‚¹å¤–ï¼Œå¿…é¡»æ»¡è¶³æ‹¥æœ‰ <code>children</code>ï¼Œå¹¶ä¸” <code>children</code> ä¸èƒ½åªæ˜¯ä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹ï¼Œä¸ç„¶çš„è¯æŠŠå®ƒæ ‡è®°æˆé™æ€æ ¹èŠ‚ç‚¹çš„æ”¶ç›Šå°±å¾ˆå°äº†ã€‚</p><p>æ¥ä¸‹æ¥å’Œæ ‡è®°é™æ€èŠ‚ç‚¹çš„é€»è¾‘ä¸€æ ·ï¼Œéå† <code>children</code> ä»¥åŠ <code>ifConditions</code>ï¼Œé€’å½’æ‰§è¡Œ <code>markStaticRoots</code>ã€‚</p><p>å›å½’æˆ‘ä»¬ä¹‹å‰çš„ä¾‹å­ï¼Œç»è¿‡ <code>optimize</code> åï¼ŒAST æ ‘å˜æˆäº†å¦‚ä¸‹ï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>ast <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token string-property property">&#39;type&#39;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token string-property property">&#39;tag&#39;</span><span class="token operator">:</span> <span class="token string">&#39;ul&#39;</span><span class="token punctuation">,</span>\n  <span class="token string-property property">&#39;attrsList&#39;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token string-property property">&#39;attrsMap&#39;</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token string-property property">&#39;:class&#39;</span><span class="token operator">:</span> <span class="token string">&#39;bindCls&#39;</span><span class="token punctuation">,</span>\n    <span class="token string-property property">&#39;class&#39;</span><span class="token operator">:</span> <span class="token string">&#39;list&#39;</span><span class="token punctuation">,</span>\n    <span class="token string-property property">&#39;v-if&#39;</span><span class="token operator">:</span> <span class="token string">&#39;isShow&#39;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token string-property property">&#39;if&#39;</span><span class="token operator">:</span> <span class="token string">&#39;isShow&#39;</span><span class="token punctuation">,</span>\n  <span class="token string-property property">&#39;ifConditions&#39;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>\n    <span class="token string-property property">&#39;exp&#39;</span><span class="token operator">:</span> <span class="token string">&#39;isShow&#39;</span><span class="token punctuation">,</span>\n    <span class="token string-property property">&#39;block&#39;</span><span class="token operator">:</span> <span class="token comment">// ul ast element</span>\n  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token string-property property">&#39;parent&#39;</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>\n  <span class="token string-property property">&#39;plain&#39;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n  <span class="token string-property property">&#39;staticClass&#39;</span><span class="token operator">:</span> <span class="token string">&#39;list&#39;</span><span class="token punctuation">,</span>\n  <span class="token string-property property">&#39;classBinding&#39;</span><span class="token operator">:</span> <span class="token string">&#39;bindCls&#39;</span><span class="token punctuation">,</span>\n  <span class="token string-property property">&#39;static&#39;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n  <span class="token string-property property">&#39;staticRoot&#39;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n  <span class="token string-property property">&#39;children&#39;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>\n    <span class="token string-property property">&#39;type&#39;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token string-property property">&#39;tag&#39;</span><span class="token operator">:</span> <span class="token string">&#39;li&#39;</span><span class="token punctuation">,</span>\n    <span class="token string-property property">&#39;attrsList&#39;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>\n      <span class="token string-property property">&#39;name&#39;</span><span class="token operator">:</span> <span class="token string">&#39;@click&#39;</span><span class="token punctuation">,</span>\n      <span class="token string-property property">&#39;value&#39;</span><span class="token operator">:</span> <span class="token string">&#39;clickItem(index)&#39;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n    <span class="token string-property property">&#39;attrsMap&#39;</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token string-property property">&#39;@click&#39;</span><span class="token operator">:</span> <span class="token string">&#39;clickItem(index)&#39;</span><span class="token punctuation">,</span>\n      <span class="token string-property property">&#39;v-for&#39;</span><span class="token operator">:</span> <span class="token string">&#39;(item,index) in data&#39;</span>\n     <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token string-property property">&#39;parent&#39;</span><span class="token operator">:</span> <span class="token comment">// ul ast element</span>\n    <span class="token string-property property">&#39;plain&#39;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n    <span class="token string-property property">&#39;events&#39;</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token string-property property">&#39;click&#39;</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token string-property property">&#39;value&#39;</span><span class="token operator">:</span> <span class="token string">&#39;clickItem(index)&#39;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token string-property property">&#39;hasBindings&#39;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    <span class="token string-property property">&#39;for&#39;</span><span class="token operator">:</span> <span class="token string">&#39;data&#39;</span><span class="token punctuation">,</span>\n    <span class="token string-property property">&#39;alias&#39;</span><span class="token operator">:</span> <span class="token string">&#39;item&#39;</span><span class="token punctuation">,</span>\n    <span class="token string-property property">&#39;iterator1&#39;</span><span class="token operator">:</span> <span class="token string">&#39;index&#39;</span><span class="token punctuation">,</span>\n    <span class="token string-property property">&#39;static&#39;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n    <span class="token string-property property">&#39;staticRoot&#39;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n    <span class="token string-property property">&#39;children&#39;</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n      <span class="token string-property property">&#39;type&#39;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>\n      <span class="token string-property property">&#39;expression&#39;</span><span class="token operator">:</span> <span class="token string">&#39;_s(item)+&quot;:&quot;+_s(index)&#39;</span>\n      <span class="token string-property property">&#39;text&#39;</span><span class="token operator">:</span> <span class="token string">&#39;{{item}}:{{index}}&#39;</span><span class="token punctuation">,</span>\n      <span class="token string-property property">&#39;tokens&#39;</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n        <span class="token punctuation">{</span><span class="token string-property property">&#39;@binding&#39;</span><span class="token operator">:</span><span class="token string">&#39;item&#39;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token string">&#39;:&#39;</span><span class="token punctuation">,</span>\n        <span class="token punctuation">{</span><span class="token string-property property">&#39;@binding&#39;</span><span class="token operator">:</span><span class="token string">&#39;index&#39;</span><span class="token punctuation">}</span>\n      <span class="token punctuation">]</span><span class="token punctuation">,</span>\n      <span class="token string-property property">&#39;static&#39;</span><span class="token operator">:</span> <span class="token boolean">false</span>\n    <span class="token punctuation">]</span>\n  <span class="token punctuation">}</span><span class="token punctuation">]</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬å‘ç°æ¯ä¸€ä¸ª AST å…ƒç´ èŠ‚ç‚¹éƒ½å¤šäº† <code>staic</code> å±æ€§ï¼Œå¹¶ä¸” <code>type</code> ä¸º 1 çš„æ™®é€šå…ƒç´  AST èŠ‚ç‚¹å¤šäº† <code>staticRoot</code> å±æ€§ã€‚</p><h2 id="æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“" aria-hidden="true">#</a> æ€»ç»“</h2><p>é‚£ä¹ˆè‡³æ­¤æˆ‘ä»¬åˆ†æå®Œäº† <code>optimize</code> çš„è¿‡ç¨‹ï¼Œå°±æ˜¯æ·±åº¦éå†è¿™ä¸ª AST æ ‘ï¼Œå»æ£€æµ‹å®ƒçš„æ¯ä¸€é¢—å­æ ‘æ˜¯ä¸æ˜¯é™æ€èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯é™æ€èŠ‚ç‚¹åˆ™å®ƒä»¬ç”Ÿæˆ DOM æ°¸è¿œä¸éœ€è¦æ”¹å˜ï¼Œè¿™å¯¹è¿è¡Œæ—¶å¯¹æ¨¡æ¿çš„æ›´æ–°èµ·åˆ°æå¤§çš„ä¼˜åŒ–ä½œç”¨ã€‚</p><p>æˆ‘ä»¬é€šè¿‡ <code>optimize</code> æˆ‘ä»¬æŠŠæ•´ä¸ª AST æ ‘ä¸­çš„æ¯ä¸€ä¸ª AST å…ƒç´ èŠ‚ç‚¹æ ‡è®°äº† <code>static</code> å’Œ <code>staticRoot</code>ï¼Œå®ƒä¼šå½±å“æˆ‘ä»¬æ¥ä¸‹æ¥æ‰§è¡Œä»£ç ç”Ÿæˆçš„è¿‡ç¨‹ã€‚</p>',21)],e={},o=(0,a(13860).Z)(e,[["render",function(n,s){return(0,t.wg)(),(0,t.iD)("div",null,p)}]])},13860:(n,s)=>{s.Z=(n,s)=>{const a=n.__vccOpts||n;for(const[n,t]of s)a[n]=t;return a}},40023:(n,s,a)=>{a.r(s),a.d(s,{data:()=>t});const t=JSON.parse('{"key":"v-cd93eed4","path":"/vue2/compile/optimize.html","title":"optimize","lang":"zh-CN","frontmatter":{"author":"ustbhuangyi","summary":"optimize å½“æˆ‘ä»¬çš„æ¨¡æ¿ template ç»è¿‡ parse è¿‡ç¨‹åï¼Œä¼šè¾“å‡ºç”Ÿæˆ AST æ ‘ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å¯¹è¿™é¢—æ ‘åšä¼˜åŒ–ï¼Œoptimize çš„é€»è¾‘æ˜¯è¿œç®€å•äº parse çš„é€»è¾‘ï¼Œæ‰€ä»¥ç†è§£èµ·æ¥ä¼šè½»æ¾å¾ˆå¤šã€‚ ä¸ºä»€ä¹ˆè¦æœ‰ä¼˜åŒ–è¿‡ç¨‹ï¼Œå› ä¸ºæˆ‘ä»¬çŸ¥é“ Vue æ˜¯æ•°æ®é©±åŠ¨ï¼Œæ˜¯å“åº”å¼çš„ï¼Œä½†æ˜¯æˆ‘ä»¬çš„æ¨¡æ¿å¹¶ä¸æ˜¯æ‰€æœ‰æ•°æ®éƒ½æ˜¯å“åº”å¼çš„ï¼Œä¹Ÿæœ‰å¾ˆå¤šæ•°æ®æ˜¯é¦–æ¬¡æ¸²æŸ“åå°±æ°¸è¿œä¸ä¼šå˜","head":[["meta",{"property":"og:url","content":"https://0808200.xyz/vue2/compile/optimize.html"}],["meta",{"property":"og:site_name","content":"ğ‘€ğ‘Ÿ.ğºğ‘œğ‘œğ‘”ğ‘¥â„"}],["meta",{"property":"og:title","content":"optimize"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:updated_time","content":"2022-08-29T09:14:21.000Z"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"article:author","content":"ustbhuangyi"}],["meta",{"property":"article:modified_time","content":"2022-08-29T09:14:21.000Z"}]]},"excerpt":"","headers":[{"level":2,"title":"æ ‡è®°é™æ€èŠ‚ç‚¹","slug":"æ ‡è®°é™æ€èŠ‚ç‚¹","children":[]},{"level":2,"title":"æ ‡è®°é™æ€æ ¹","slug":"æ ‡è®°é™æ€æ ¹","children":[]},{"level":2,"title":"æ€»ç»“","slug":"æ€»ç»“","children":[]}],"git":{"createdTime":1661764461000,"updatedTime":1661764461000,"contributors":[{"name":"googxh","email":"gxh522@qq.com","commits":1}]},"readingTime":{"minutes":4.38,"words":1315},"filePathRelative":"vue2/compile/optimize.md","localizedDate":"2022å¹´8æœˆ29æ—¥"}')}}]);