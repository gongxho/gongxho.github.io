"use strict";(self.webpackChunkmyblog=self.webpackChunkmyblog||[]).push([[36832],{54327:(n,s,a)=>{a.r(s),a.d(s,{default:()=>i});var e=a(60329);const t=(0,e.uE)('<h1 id="nexttick" tabindex="-1"><a class="header-anchor" href="#nexttick" aria-hidden="true">#</a> nextTick</h1><p><code>nextTick</code> æ˜¯ Vue çš„ä¸€ä¸ªæ ¸å¿ƒå®ç°ï¼Œåœ¨ä»‹ç» Vue çš„ nextTick ä¹‹å‰ï¼Œä¸ºäº†æ–¹ä¾¿å¤§å®¶ç†è§£ï¼Œæˆ‘å…ˆç®€å•ä»‹ç»ä¸€ä¸‹ JS çš„è¿è¡Œæœºåˆ¶ã€‚</p><h2 id="js-è¿è¡Œæœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#js-è¿è¡Œæœºåˆ¶" aria-hidden="true">#</a> JS è¿è¡Œæœºåˆ¶</h2><p>JS æ‰§è¡Œæ˜¯å•çº¿ç¨‹çš„ï¼Œå®ƒæ˜¯åŸºäºäº‹ä»¶å¾ªç¯çš„ã€‚äº‹ä»¶å¾ªç¯å¤§è‡´åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p><p>ï¼ˆ1ï¼‰æ‰€æœ‰åŒæ­¥ä»»åŠ¡éƒ½åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œå½¢æˆä¸€ä¸ªæ‰§è¡Œæ ˆï¼ˆexecution context stackï¼‰ã€‚</p><p>ï¼ˆ2ï¼‰ä¸»çº¿ç¨‹ä¹‹å¤–ï¼Œè¿˜å­˜åœ¨ä¸€ä¸ª&quot;ä»»åŠ¡é˜Ÿåˆ—&quot;ï¼ˆtask queueï¼‰ã€‚åªè¦å¼‚æ­¥ä»»åŠ¡æœ‰äº†è¿è¡Œç»“æœï¼Œå°±åœ¨&quot;ä»»åŠ¡é˜Ÿåˆ—&quot;ä¹‹ä¸­æ”¾ç½®ä¸€ä¸ªäº‹ä»¶ã€‚</p><p>ï¼ˆ3ï¼‰ä¸€æ—¦&quot;æ‰§è¡Œæ ˆ&quot;ä¸­çš„æ‰€æœ‰åŒæ­¥ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œç³»ç»Ÿå°±ä¼šè¯»å–&quot;ä»»åŠ¡é˜Ÿåˆ—&quot;ï¼Œçœ‹çœ‹é‡Œé¢æœ‰å“ªäº›äº‹ä»¶ã€‚é‚£äº›å¯¹åº”çš„å¼‚æ­¥ä»»åŠ¡ï¼Œäºæ˜¯ç»“æŸç­‰å¾…çŠ¶æ€ï¼Œè¿›å…¥æ‰§è¡Œæ ˆï¼Œå¼€å§‹æ‰§è¡Œã€‚</p><p>ï¼ˆ4ï¼‰ä¸»çº¿ç¨‹ä¸æ–­é‡å¤ä¸Šé¢çš„ç¬¬ä¸‰æ­¥ã€‚</p>',8),p=["src"],o=(0,e.uE)('<p>ä¸»çº¿ç¨‹çš„æ‰§è¡Œè¿‡ç¨‹å°±æ˜¯ä¸€ä¸ª tickï¼Œè€Œæ‰€æœ‰çš„å¼‚æ­¥ç»“æœéƒ½æ˜¯é€šè¿‡ â€œä»»åŠ¡é˜Ÿåˆ—â€ æ¥è°ƒåº¦ã€‚ æ¶ˆæ¯é˜Ÿåˆ—ä¸­å­˜æ”¾çš„æ˜¯ä¸€ä¸ªä¸ªçš„ä»»åŠ¡ï¼ˆtaskï¼‰ã€‚ è§„èŒƒä¸­è§„å®š task åˆ†ä¸ºä¸¤å¤§ç±»ï¼Œåˆ†åˆ«æ˜¯ macro task å’Œ micro taskï¼Œå¹¶ä¸”æ¯ä¸ª macro task ç»“æŸåï¼Œéƒ½è¦æ¸…ç©ºæ‰€æœ‰çš„ micro taskã€‚</p><p>å…³äº macro task å’Œ micro task çš„æ¦‚å¿µï¼Œè¿™é‡Œä¸ä¼šç»†è®²ï¼Œç®€å•é€šè¿‡ä¸€æ®µä»£ç æ¼”ç¤ºä»–ä»¬çš„æ‰§è¡Œé¡ºåºï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">for</span> <span class="token punctuation">(</span>macroTask <span class="token keyword">of</span> macroTaskQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 1. Handle current MACRO-TASK</span>\n    <span class="token function">handleMacroTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      \n    <span class="token comment">// 2. Handle all MICRO-TASK</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span>microTask <span class="token keyword">of</span> microTaskQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">handleMicroTask</span><span class="token punctuation">(</span>microTask<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨æµè§ˆå™¨ç¯å¢ƒä¸­ï¼Œå¸¸è§çš„ macro task æœ‰ setTimeoutã€MessageChannelã€postMessageã€setImmediateï¼›å¸¸è§çš„ micro task æœ‰ MutationObsever å’Œ Promise.thenã€‚</p><h2 id="vue-çš„å®ç°" tabindex="-1"><a class="header-anchor" href="#vue-çš„å®ç°" aria-hidden="true">#</a> Vue çš„å®ç°</h2><p>åœ¨ Vue æºç  2.5+ åï¼Œ<code>nextTick</code> çš„å®ç°å•ç‹¬æœ‰ä¸€ä¸ª JS æ–‡ä»¶æ¥ç»´æŠ¤å®ƒï¼Œå®ƒçš„æºç å¹¶ä¸å¤šï¼Œæ€»å…±ä¹Ÿå°± 100 å¤šè¡Œã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒçš„å®ç°ï¼Œåœ¨ <code>src/core/util/next-tick.js</code> ä¸­ï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> noop <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;shared/util&#39;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> handleError <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./error&#39;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> isIOS<span class="token punctuation">,</span> isNative <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./env&#39;</span>\n\n<span class="token keyword">const</span> callbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token keyword">let</span> pending <span class="token operator">=</span> <span class="token boolean">false</span>\n\n<span class="token keyword">function</span> <span class="token function">flushCallbacks</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  pending <span class="token operator">=</span> <span class="token boolean">false</span>\n  <span class="token keyword">const</span> copies <span class="token operator">=</span> callbacks<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>\n  callbacks<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> copies<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    copies<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// Here we have async deferring wrappers using both microtasks and (macro) tasks.</span>\n<span class="token comment">// In &lt; 2.4 we used microtasks everywhere, but there are some scenarios where</span>\n<span class="token comment">// microtasks have too high a priority and fire in between supposedly</span>\n<span class="token comment">// sequential events (e.g. #4521, #6690) or even between bubbling of the same</span>\n<span class="token comment">// event (#6566). However, using (macro) tasks everywhere also has subtle problems</span>\n<span class="token comment">// when state is changed right before repaint (e.g. #6813, out-in transitions).</span>\n<span class="token comment">// Here we use microtask by default, but expose a way to force (macro) task when</span>\n<span class="token comment">// needed (e.g. in event handlers attached by v-on).</span>\n<span class="token keyword">let</span> microTimerFunc\n<span class="token keyword">let</span> macroTimerFunc\n<span class="token keyword">let</span> useMacroTask <span class="token operator">=</span> <span class="token boolean">false</span>\n\n<span class="token comment">// Determine (macro) task defer implementation.</span>\n<span class="token comment">// Technically setImmediate should be the ideal choice, but it&#39;s only available</span>\n<span class="token comment">// in IE. The only polyfill that consistently queues the callback after all DOM</span>\n<span class="token comment">// events triggered in the same loop is by using MessageChannel.</span>\n<span class="token comment">/* istanbul ignore if */</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> setImmediate <span class="token operator">!==</span> <span class="token string">&#39;undefined&#39;</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isNative</span><span class="token punctuation">(</span>setImmediate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function-variable function">macroTimerFunc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    <span class="token function">setImmediate</span><span class="token punctuation">(</span>flushCallbacks<span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> MessageChannel <span class="token operator">!==</span> <span class="token string">&#39;undefined&#39;</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>\n  <span class="token function">isNative</span><span class="token punctuation">(</span>MessageChannel<span class="token punctuation">)</span> <span class="token operator">||</span>\n  <span class="token comment">// PhantomJS</span>\n  MessageChannel<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&#39;[object MessageChannelConstructor]&#39;</span>\n<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> channel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> port <span class="token operator">=</span> channel<span class="token punctuation">.</span>port2\n  channel<span class="token punctuation">.</span>port1<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> flushCallbacks\n  <span class="token function-variable function">macroTimerFunc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n  <span class="token comment">/* istanbul ignore next */</span>\n  <span class="token function-variable function">macroTimerFunc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    <span class="token function">setTimeout</span><span class="token punctuation">(</span>flushCallbacks<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// Determine microtask defer implementation.</span>\n<span class="token comment">/* istanbul ignore next, $flow-disable-line */</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> Promise <span class="token operator">!==</span> <span class="token string">&#39;undefined&#39;</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isNative</span><span class="token punctuation">(</span>Promise<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  <span class="token function-variable function">microTimerFunc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>flushCallbacks<span class="token punctuation">)</span>\n    <span class="token comment">// in problematic UIWebViews, Promise.then doesn&#39;t completely break, but</span>\n    <span class="token comment">// it can get stuck in a weird state where callbacks are pushed into the</span>\n    <span class="token comment">// microtask queue but the queue isn&#39;t being flushed, until the browser</span>\n    <span class="token comment">// needs to do some other work, e.g. handle a timer. Therefore we can</span>\n    <span class="token comment">// &quot;force&quot; the microtask queue to be flushed by adding an empty timer.</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>isIOS<span class="token punctuation">)</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>noop<span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n  <span class="token comment">// fallback to macro</span>\n  microTimerFunc <span class="token operator">=</span> macroTimerFunc\n<span class="token punctuation">}</span>\n\n<span class="token doc-comment comment">/**\n * Wrap a function so that if any code inside triggers state change,\n * the changes are queued using a (macro) task instead of a microtask.\n */</span>\n<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">withMacroTask</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">fn</span><span class="token operator">:</span> Function</span><span class="token punctuation">)</span><span class="token operator">:</span> Function <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> fn<span class="token punctuation">.</span>_withTask <span class="token operator">||</span> <span class="token punctuation">(</span>fn<span class="token punctuation">.</span><span class="token function-variable function">_withTask</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    useMacroTask <span class="token operator">=</span> <span class="token boolean">true</span>\n    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span>\n    useMacroTask <span class="token operator">=</span> <span class="token boolean">false</span>\n    <span class="token keyword">return</span> res\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">nextTick</span> <span class="token punctuation">(</span><span class="token parameter">cb<span class="token operator">?</span><span class="token operator">:</span> Function<span class="token punctuation">,</span> ctx<span class="token operator">?</span><span class="token operator">:</span> Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> _resolve\n  callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">try</span> <span class="token punctuation">{</span>\n        <span class="token function">cb</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>\n      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">handleError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> <span class="token string">&#39;nextTick&#39;</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>_resolve<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">_resolve</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pending<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    pending <span class="token operator">=</span> <span class="token boolean">true</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>useMacroTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">macroTimerFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token function">microTimerFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// $flow-disable-line</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cb <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> Promise <span class="token operator">!==</span> <span class="token string">&#39;undefined&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n      _resolve <span class="token operator">=</span> resolve\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>next-tick.js</code> ç”³æ˜äº† <code>microTimerFunc</code> å’Œ <code>macroTimerFunc</code> 2 ä¸ªå˜é‡ï¼Œå®ƒä»¬åˆ†åˆ«å¯¹åº”çš„æ˜¯ micro task çš„å‡½æ•°å’Œ macro task çš„å‡½æ•°ã€‚å¯¹äº macro task çš„å®ç°ï¼Œä¼˜å…ˆæ£€æµ‹æ˜¯å¦æ”¯æŒåŸç”Ÿ <code>setImmediate</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªé«˜ç‰ˆæœ¬ IE å’Œ Edge æ‰æ”¯æŒçš„ç‰¹æ€§ï¼Œä¸æ”¯æŒçš„è¯å†å»æ£€æµ‹æ˜¯å¦æ”¯æŒåŸç”Ÿçš„ <code>MessageChannel</code>ï¼Œå¦‚æœä¹Ÿä¸æ”¯æŒçš„è¯å°±ä¼šé™çº§ä¸º <code>setTimeout 0</code>ï¼›è€Œå¯¹äº micro task çš„å®ç°ï¼Œåˆ™æ£€æµ‹æµè§ˆå™¨æ˜¯å¦åŸç”Ÿæ”¯æŒ Promiseï¼Œä¸æ”¯æŒçš„è¯ç›´æ¥æŒ‡å‘ macro task çš„å®ç°ã€‚</p><p><code>next-tick.js</code> å¯¹å¤–æš´éœ²äº† 2 ä¸ªå‡½æ•°ï¼Œå…ˆæ¥çœ‹ <code>nextTick</code>ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚æ‰§è¡Œ <code>nextTick(flushSchedulerQueue)</code> æ‰€ç”¨åˆ°çš„å‡½æ•°ã€‚å®ƒçš„é€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼ŒæŠŠä¼ å…¥çš„å›è°ƒå‡½æ•° <code>cb</code> å‹å…¥ <code>callbacks</code> æ•°ç»„ï¼Œæœ€åä¸€æ¬¡æ€§åœ°æ ¹æ® <code>useMacroTask</code> æ¡ä»¶æ‰§è¡Œ <code>macroTimerFunc</code> æˆ–è€…æ˜¯ <code>microTimerFunc</code>ï¼Œè€Œå®ƒä»¬éƒ½ä¼šåœ¨ä¸‹ä¸€ä¸ª tick æ‰§è¡Œ <code>flushCallbacks</code>ï¼Œ<code>flushCallbacks</code> çš„é€»è¾‘éå¸¸ç®€å•ï¼Œå¯¹ <code>callbacks</code> éå†ï¼Œç„¶åæ‰§è¡Œç›¸åº”çš„å›è°ƒå‡½æ•°ã€‚</p><p>è¿™é‡Œä½¿ç”¨ <code>callbacks</code> è€Œä¸æ˜¯ç›´æ¥åœ¨ <code>nextTick</code> ä¸­æ‰§è¡Œå›è°ƒå‡½æ•°çš„åŸå› æ˜¯ä¿è¯åœ¨åŒä¸€ä¸ª tick å†…å¤šæ¬¡æ‰§è¡Œ <code>nextTick</code>ï¼Œä¸ä¼šå¼€å¯å¤šä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œè€ŒæŠŠè¿™äº›å¼‚æ­¥ä»»åŠ¡éƒ½å‹æˆä¸€ä¸ªåŒæ­¥ä»»åŠ¡ï¼Œåœ¨ä¸‹ä¸€ä¸ª tick æ‰§è¡Œå®Œæ¯•ã€‚</p><p><code>nextTick</code> å‡½æ•°æœ€åè¿˜æœ‰ä¸€æ®µé€»è¾‘ï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cb <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> Promise <span class="token operator">!==</span> <span class="token string">&#39;undefined&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    _resolve <span class="token operator">=</span> resolve\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ˜¯å½“ <code>nextTick</code> ä¸ä¼  <code>cb</code> å‚æ•°çš„æ—¶å€™ï¼Œæä¾›ä¸€ä¸ª Promise åŒ–çš„è°ƒç”¨ï¼Œæ¯”å¦‚ï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å½“ <code>_resolve</code> å‡½æ•°æ‰§è¡Œï¼Œå°±ä¼šè·³åˆ° <code>then</code> çš„é€»è¾‘ä¸­ã€‚</p><p><code>next-tick.js</code> è¿˜å¯¹å¤–æš´éœ²äº† <code>withMacroTask</code> å‡½æ•°ï¼Œå®ƒæ˜¯å¯¹å‡½æ•°åšä¸€å±‚åŒ…è£…ï¼Œç¡®ä¿å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­å¯¹æ•°æ®ä»»æ„çš„ä¿®æ”¹ï¼Œè§¦å‘å˜åŒ–æ‰§è¡Œ <code>nextTick</code> çš„æ—¶å€™å¼ºåˆ¶èµ° <code>macroTimerFunc</code>ã€‚æ¯”å¦‚å¯¹äºä¸€äº› DOM äº¤äº’äº‹ä»¶ï¼Œå¦‚ <code>v-on</code> ç»‘å®šçš„äº‹ä»¶å›è°ƒå‡½æ•°çš„å¤„ç†ï¼Œä¼šå¼ºåˆ¶èµ° macro taskã€‚</p><h2 id="æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“" aria-hidden="true">#</a> æ€»ç»“</h2><p>é€šè¿‡è¿™ä¸€èŠ‚å¯¹ <code>nextTick</code> çš„åˆ†æï¼Œå¹¶ç»“åˆä¸Šä¸€èŠ‚çš„ setter åˆ†æï¼Œæˆ‘ä»¬äº†è§£åˆ°æ•°æ®çš„å˜åŒ–åˆ° DOM çš„é‡æ–°æ¸²æŸ“æ˜¯ä¸€ä¸ªå¼‚æ­¥è¿‡ç¨‹ï¼Œå‘ç”Ÿåœ¨ä¸‹ä¸€ä¸ª tickã€‚è¿™å°±æ˜¯æˆ‘ä»¬å¹³æ—¶åœ¨å¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œæ¯”å¦‚ä»æœåŠ¡ç«¯æ¥å£å»è·å–æ•°æ®çš„æ—¶å€™ï¼Œæ•°æ®åšäº†ä¿®æ”¹ï¼Œå¦‚æœæˆ‘ä»¬çš„æŸäº›æ–¹æ³•å»ä¾èµ–äº†æ•°æ®ä¿®æ”¹åçš„ DOM å˜åŒ–ï¼Œæˆ‘ä»¬å°±å¿…é¡»åœ¨ <code>nextTick</code> åæ‰§è¡Œã€‚æ¯”å¦‚ä¸‹é¢çš„ä¼ªä»£ç ï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">getData</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>xxx <span class="token operator">=</span> res<span class="token punctuation">.</span>data\n  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    <span class="token comment">// è¿™é‡Œæˆ‘ä»¬å¯ä»¥è·å–å˜åŒ–åçš„ DOM</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Vue.js æä¾›äº† 2 ç§è°ƒç”¨ <code>nextTick</code> çš„æ–¹å¼ï¼Œä¸€ç§æ˜¯å…¨å±€ API <code>Vue.nextTick</code>ï¼Œä¸€ç§æ˜¯å®ä¾‹ä¸Šçš„æ–¹æ³• <code>vm.$nextTick</code>ï¼Œæ— è®ºæˆ‘ä»¬ä½¿ç”¨å“ªä¸€ç§ï¼Œæœ€åéƒ½æ˜¯è°ƒç”¨ <code>next-tick.js</code> ä¸­å®ç°çš„ <code>nextTick</code> æ–¹æ³•ã€‚</p>',20),c={},i=(0,a(13860).Z)(c,[["render",function(n,s){return(0,e.wg)(),(0,e.iD)("div",null,[t,(0,e._)("img",{src:n.$withBase("/assets/event-loop.png")},null,8,p),o])}]])},13860:(n,s)=>{s.Z=(n,s)=>{const a=n.__vccOpts||n;for(const[n,e]of s)a[n]=e;return a}},84542:(n,s,a)=>{a.r(s),a.d(s,{data:()=>e});const e=JSON.parse('{"key":"v-f65eeaa4","path":"/vue2/reactive/next-tick.html","title":"nextTick","lang":"zh-CN","frontmatter":{"author":"ustbhuangyi","summary":"nextTick nextTick æ˜¯ Vue çš„ä¸€ä¸ªæ ¸å¿ƒå®ç°ï¼Œåœ¨ä»‹ç» Vue çš„ nextTick ä¹‹å‰ï¼Œä¸ºäº†æ–¹ä¾¿å¤§å®¶ç†è§£ï¼Œæˆ‘å…ˆç®€å•ä»‹ç»ä¸€ä¸‹ JS çš„è¿è¡Œæœºåˆ¶ã€‚ JS è¿è¡Œæœºåˆ¶ JS æ‰§è¡Œæ˜¯å•çº¿ç¨‹çš„ï¼Œå®ƒæ˜¯åŸºäºäº‹ä»¶å¾ªç¯çš„ã€‚äº‹ä»¶å¾ªç¯å¤§è‡´åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š ï¼ˆ1ï¼‰æ‰€æœ‰åŒæ­¥ä»»åŠ¡éƒ½åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œå½¢æˆä¸€ä¸ªæ‰§è¡Œæ ˆï¼ˆexecution context stackï¼‰ã€‚ ï¼ˆ","head":[["meta",{"property":"og:url","content":"https://0808200.xyz/vue2/reactive/next-tick.html"}],["meta",{"property":"og:site_name","content":"ğ‘€ğ‘Ÿ.ğ‘”ğ‘œğ‘œğ‘”ğ‘¥â„"}],["meta",{"property":"og:title","content":"nextTick"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:updated_time","content":"2022-08-29T09:14:21.000Z"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"article:author","content":"ustbhuangyi"}],["meta",{"property":"article:modified_time","content":"2022-08-29T09:14:21.000Z"}]]},"excerpt":"","headers":[{"level":2,"title":"JS è¿è¡Œæœºåˆ¶","slug":"js-è¿è¡Œæœºåˆ¶","children":[]},{"level":2,"title":"Vue çš„å®ç°","slug":"vue-çš„å®ç°","children":[]},{"level":2,"title":"æ€»ç»“","slug":"æ€»ç»“","children":[]}],"git":{"createdTime":1661764461000,"updatedTime":1661764461000,"contributors":[{"name":"googxh","email":"gxh522@qq.com","commits":1}]},"readingTime":{"minutes":5.11,"words":1534},"filePathRelative":"vue2/reactive/next-tick.md","localizedDate":"2022å¹´8æœˆ29æ—¥"}')}}]);