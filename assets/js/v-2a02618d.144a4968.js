"use strict";(self.webpackChunkmyblog=self.webpackChunkmyblog||[]).push([[54445],{31693:(n,s,a)=>{a.r(s),a.d(s,{default:()=>_n});var e=a(78e3);const t=(0,e.uE)('<p>终于到了执行<code>DOM</code>操作的<code>mutation阶段</code>。</p><h2 id="概览" tabindex="-1"><a class="header-anchor" href="#概览" aria-hidden="true">#</a> 概览</h2><p>类似<code>before mutation阶段</code>，<code>mutation阶段</code>也是遍历<code>effectList</code>，执行函数。这里执行的是<code>commitMutationEffects</code>。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>nextEffect <span class="token operator">=</span> firstEffect<span class="token punctuation">;</span>\n<span class="token keyword">do</span> <span class="token punctuation">{</span>\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n      <span class="token function">commitMutationEffects</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">invariant</span><span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&#39;Should be working on an effect.&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">captureCommitPhaseError</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="commitmutationeffects" tabindex="-1"><a class="header-anchor" href="#commitmutationeffects" aria-hidden="true">#</a> commitMutationEffects</h2><p>代码如下：</p>',6),o=(0,e.Uk)("你可以在"),p={href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberWorkLoop.old.js#L2091",target:"_blank",rel:"noopener noreferrer"},c=(0,e.Uk)("这里"),l=(0,e.Uk)("看到"),i=(0,e._)("code",null,"commitMutationEffects",-1),r=(0,e.Uk)("源码"),u=(0,e.uE)('<div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">commitMutationEffects</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">root</span><span class="token operator">:</span> FiberRoot<span class="token punctuation">,</span> renderPriorityLevel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 遍历effectList</span>\n  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n\n    <span class="token keyword">const</span> effectTag <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>effectTag<span class="token punctuation">;</span>\n\n    <span class="token comment">// 根据 ContentReset effectTag重置文字节点</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> ContentReset<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">commitResetTextContent</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 更新ref</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> Ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">commitDetachRef</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 根据 effectTag 分别处理</span>\n    <span class="token keyword">const</span> primaryEffectTag <span class="token operator">=</span>\n      effectTag <span class="token operator">&amp;</span> <span class="token punctuation">(</span>Placement <span class="token operator">|</span> Update <span class="token operator">|</span> Deletion <span class="token operator">|</span> Hydrating<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">switch</span> <span class="token punctuation">(</span>primaryEffectTag<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 插入DOM</span>\n      <span class="token keyword">case</span> <span class="token literal-property property">Placement</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token function">commitPlacement</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        nextEffect<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;=</span> <span class="token operator">~</span>Placement<span class="token punctuation">;</span>\n        <span class="token keyword">break</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// 插入DOM 并 更新DOM</span>\n      <span class="token keyword">case</span> <span class="token literal-property property">PlacementAndUpdate</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 插入</span>\n        <span class="token function">commitPlacement</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        nextEffect<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;=</span> <span class="token operator">~</span>Placement<span class="token punctuation">;</span>\n\n        <span class="token comment">// 更新</span>\n        <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>\n        <span class="token function">commitWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">break</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// SSR</span>\n      <span class="token keyword">case</span> <span class="token literal-property property">Hydrating</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        nextEffect<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;=</span> <span class="token operator">~</span>Hydrating<span class="token punctuation">;</span>\n        <span class="token keyword">break</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// SSR</span>\n      <span class="token keyword">case</span> <span class="token literal-property property">HydratingAndUpdate</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        nextEffect<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;=</span> <span class="token operator">~</span>Hydrating<span class="token punctuation">;</span>\n\n        <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>\n        <span class="token function">commitWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">break</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// 更新DOM</span>\n      <span class="token keyword">case</span> <span class="token literal-property property">Update</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>\n        <span class="token function">commitWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">break</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// 删除DOM</span>\n      <span class="token keyword">case</span> <span class="token literal-property property">Deletion</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token function">commitDeletion</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> nextEffect<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">break</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>commitMutationEffects</code>会遍历<code>effectList</code>，对每个<code>Fiber节点</code>执行如下三个操作：</p><ol><li>根据<code>ContentReset effectTag</code>重置文字节点</li><li>更新<code>ref</code></li><li>根据<code>effectTag</code>分别处理，其中<code>effectTag</code>包括(<code>Placement</code> | <code>Update</code> | <code>Deletion</code> | <code>Hydrating</code>)</li></ol><p>我们关注步骤三中的<code>Placement</code> | <code>Update</code> | <code>Deletion</code>。<code>Hydrating</code>作为服务端渲染相关，我们先不关注。</p><h2 id="placement-effect" tabindex="-1"><a class="header-anchor" href="#placement-effect" aria-hidden="true">#</a> Placement effect</h2><p>当<code>Fiber节点</code>含有<code>Placement effectTag</code>，意味着该<code>Fiber节点</code>对应的<code>DOM节点</code>需要插入到页面中。</p><p>调用的方法为<code>commitPlacement</code>。</p>',7),d=(0,e.Uk)("你可以在"),k={href:"https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCommitWork.new.js#L1156",target:"_blank",rel:"noopener noreferrer"},m=(0,e.Uk)("这里"),v=(0,e.Uk)("看到"),b=(0,e._)("code",null,"commitPlacement",-1),f=(0,e.Uk)("源码"),g=(0,e.uE)('<p>该方法所做的工作分为三步：</p><ol><li>获取父级<code>DOM节点</code>。其中<code>finishedWork</code>为传入的<code>Fiber节点</code>。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> parentFiber <span class="token operator">=</span> <span class="token function">getHostParentFiber</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 父级DOM节点</span>\n<span class="token keyword">const</span> parentStateNode <span class="token operator">=</span> parentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>获取<code>Fiber节点</code>的<code>DOM</code>兄弟节点</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> before <span class="token operator">=</span> <span class="token function">getHostSibling</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="3"><li>根据<code>DOM</code>兄弟节点是否存在决定调用<code>parentNode.insertBefore</code>或<code>parentNode.appendChild</code>执行<code>DOM</code>插入操作。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// parentStateNode是否是rootFiber</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>isContainer<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">insertOrAppendPlacementNodeIntoContainer</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">,</span> before<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n  <span class="token function">insertOrAppendPlacementNode</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">,</span> before<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>值得注意的是，<code>getHostSibling</code>（获取兄弟<code>DOM节点</code>）的执行很耗时，当在同一个父<code>Fiber节点</code>下依次执行多个插入操作，<code>getHostSibling</code>算法的复杂度为指数级。</p><p>这是由于<code>Fiber节点</code>不只包括<code>HostComponent</code>，所以<code>Fiber树</code>和渲染的<code>DOM树</code>节点并不是一一对应的。要从<code>Fiber节点</code>找到<code>DOM节点</code>很可能跨层级遍历。</p><p>考虑如下例子：</p><div class="language-jsx ext-jsx line-numbers-mode"><pre class="language-jsx"><code>\n<span class="token keyword">function</span> <span class="token function">Item</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">;\n}\n\nfunction App() </span><span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span></span><span class="token punctuation">/&gt;</span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>\n  <span class="token punctuation">)</span>\n<span class="token punctuation">}</span><span class="token plain-text">\n\nReactDOM.render(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">App</span></span><span class="token punctuation">/&gt;</span></span><span class="token plain-text">, document.getElementById(&#39;root&#39;));\n</span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对应的<code>Fiber树</code>和<code>DOM树</code>结构为：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// Fiber树</span>\n          child      child      child       child\nrootFiber <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span> App <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span> div <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span> Item <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span> li\n\n<span class="token comment">// DOM树</span>\n#root <span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span> div <span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span> li\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当在<code>div</code>的子节点<code>Item</code>前插入一个新节点<code>p</code>，即<code>App</code>变为：</p><div class="language-jsx ext-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span></span><span class="token punctuation">/&gt;</span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>\n  <span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对应的<code>Fiber树</code>和<code>DOM树</code>结构为：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// Fiber树</span>\n          child      child      child\nrootFiber <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span> App <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span> div <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span> p \n                                       <span class="token operator">|</span> sibling       child\n                                       <span class="token operator">|</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span> Item <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span> li \n<span class="token comment">// DOM树</span>\n#root <span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span> div <span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span> p\n             <span class="token operator">|</span>\n               <span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span> li\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此时<code>DOM节点</code> <code>p</code>的兄弟节点为<code>li</code>，而<code>Fiber节点</code> <code>p</code>对应的兄弟<code>DOM节点</code>为：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>fiberP<span class="token punctuation">.</span>sibling<span class="token punctuation">.</span>child\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>即<code>fiber p</code>的<code>兄弟fiber</code> <code>Item</code>的<code>子fiber</code> <code>li</code></p><h2 id="update-effect" tabindex="-1"><a class="header-anchor" href="#update-effect" aria-hidden="true">#</a> Update effect</h2><p>当<code>Fiber节点</code>含有<code>Update effectTag</code>，意味着该<code>Fiber节点</code>需要更新。调用的方法为<code>commitWork</code>，他会根据<code>Fiber.tag</code>分别处理。</p>',22),h=(0,e.Uk)("你可以在"),y={href:"https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCommitWork.new.js#L1441",target:"_blank",rel:"noopener noreferrer"},E=(0,e.Uk)("这里"),x=(0,e.Uk)("看到"),w=(0,e._)("code",null,"commitWork",-1),_=(0,e.Uk)("源码"),U=(0,e.uE)('<p>这里我们主要关注<code>FunctionComponent</code>和<code>HostComponent</code>。</p><h3 id="functioncomponent-mutation" tabindex="-1"><a class="header-anchor" href="#functioncomponent-mutation" aria-hidden="true">#</a> FunctionComponent mutation</h3><p>当<code>fiber.tag</code>为<code>FunctionComponent</code>，会调用<code>commitHookEffectListUnmount</code>。该方法会遍历<code>effectList</code>，执行所有<code>useLayoutEffect hook</code>的销毁函数。</p>',3),j=(0,e.Uk)("你可以在"),D={href:"https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCommitWork.new.js#L314",target:"_blank",rel:"noopener noreferrer"},F=(0,e.Uk)("这里"),M=(0,e.Uk)("看到"),C=(0,e._)("code",null,"commitHookEffectListUnmount",-1),O=(0,e.Uk)("源码"),T=(0,e.uE)('<p>所谓“销毁函数”，见如下例子：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">useLayoutEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...一些副作用逻辑</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    <span class="token comment">// ...这就是销毁函数</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>你不需要很了解<code>useLayoutEffect</code>，我们会在下一节详细介绍。你只需要知道在<code>mutation阶段</code>会执行<code>useLayoutEffect</code>的销毁函数。</p><h3 id="hostcomponent-mutation" tabindex="-1"><a class="header-anchor" href="#hostcomponent-mutation" aria-hidden="true">#</a> HostComponent mutation</h3><p>当<code>fiber.tag</code>为<code>HostComponent</code>，会调用<code>commitUpdate</code>。</p>',5),L=(0,e.Uk)("你可以在"),P={href:"https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-dom/src/client/ReactDOMHostConfig.js#L423",target:"_blank",rel:"noopener noreferrer"},W=(0,e.Uk)("这里"),R=(0,e.Uk)("看到"),H=(0,e._)("code",null,"commitUpdate",-1),S=(0,e.Uk)("源码"),N=(0,e.Uk)("最终会在"),I={href:"https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-dom/src/client/ReactDOMComponent.js#L378",target:"_blank",rel:"noopener noreferrer"},A=(0,e._)("code",null,"updateDOMProperties",-1),q=(0,e.Uk)("中将"),V={href:"https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCompleteWork.new.js#L229",target:"_blank",rel:"noopener noreferrer"},K=(0,e._)("code",null,"render阶段 completeWork",-1),z=(0,e.Uk)("中为"),B=(0,e._)("code",null,"Fiber节点",-1),Z=(0,e.Uk)("赋值的"),Y=(0,e._)("code",null,"updateQueue",-1),G=(0,e.Uk)("对应的内容渲染在页面上。"),J=(0,e.uE)('<div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> updatePayload<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> propKey <span class="token operator">=</span> updatePayload<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> propValue <span class="token operator">=</span> updatePayload<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 处理 style</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">===</span> <span class="token constant">STYLE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">setValueForStyles</span><span class="token punctuation">(</span>domElement<span class="token punctuation">,</span> propValue<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 处理 DANGEROUSLY_SET_INNER_HTML</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">===</span> <span class="token constant">DANGEROUSLY_SET_INNER_HTML</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">setInnerHTML</span><span class="token punctuation">(</span>domElement<span class="token punctuation">,</span> propValue<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 处理 children</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">===</span> <span class="token constant">CHILDREN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">setTextContent</span><span class="token punctuation">(</span>domElement<span class="token punctuation">,</span> propValue<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 处理剩余 props</span>\n    <span class="token function">setValueForProperty</span><span class="token punctuation">(</span>domElement<span class="token punctuation">,</span> propKey<span class="token punctuation">,</span> propValue<span class="token punctuation">,</span> isCustomComponentTag<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="deletion-effect" tabindex="-1"><a class="header-anchor" href="#deletion-effect" aria-hidden="true">#</a> Deletion effect</h2><p>当<code>Fiber节点</code>含有<code>Deletion effectTag</code>，意味着该<code>Fiber节点</code>对应的<code>DOM节点</code>需要从页面中删除。调用的方法为<code>commitDeletion</code>。</p>',3),Q=(0,e.Uk)("你可以在"),X={href:"https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCommitWork.new.js#L1421",target:"_blank",rel:"noopener noreferrer"},$=(0,e.Uk)("这里"),nn=(0,e.Uk)("看到"),sn=(0,e._)("code",null,"commitDeletion",-1),an=(0,e.Uk)("源码"),en=(0,e._)("p",null,"该方法会执行如下操作：",-1),tn=(0,e.Uk)("递归调用"),on=(0,e._)("code",null,"Fiber节点",-1),pn=(0,e.Uk)("及其子孙"),cn=(0,e._)("code",null,"Fiber节点",-1),ln=(0,e.Uk)("中"),rn=(0,e._)("code",null,"fiber.tag",-1),un=(0,e.Uk)("为"),dn=(0,e._)("code",null,"ClassComponent",-1),kn=(0,e.Uk)("的"),mn={href:"https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCommitWork.new.js#L920",target:"_blank",rel:"noopener noreferrer"},vn=(0,e._)("code",null,"componentWillUnmount",-1),bn=(0,e.Uk)("生命周期钩子，从页面移除"),fn=(0,e._)("code",null,"Fiber节点",-1),gn=(0,e.Uk)("对应"),hn=(0,e._)("code",null,"DOM节点",-1),yn=(0,e._)("li",null,[(0,e.Uk)("解绑"),(0,e._)("code",null,"ref")],-1),En=(0,e._)("li",null,[(0,e.Uk)("调度"),(0,e._)("code",null,"useEffect"),(0,e.Uk)("的销毁函数")],-1),xn=(0,e.uE)('<h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><p>从这节我们学到，<code>mutation阶段</code>会遍历<code>effectList</code>，依次执行<code>commitMutationEffects</code>。该方法的主要工作为“根据<code>effectTag</code>调用不同的处理函数处理<code>Fiber</code>。</p>',2),wn={},_n=(0,a(13860).Z)(wn,[["render",function(n,s){const a=(0,e.up)("ExternalLinkIcon");return(0,e.wg)(),(0,e.iD)("div",null,[t,(0,e._)("blockquote",null,[(0,e._)("p",null,[o,(0,e._)("a",p,[c,(0,e.Wm)(a)]),l,i,r])]),u,(0,e._)("blockquote",null,[(0,e._)("p",null,[d,(0,e._)("a",k,[m,(0,e.Wm)(a)]),v,b,f])]),g,(0,e._)("blockquote",null,[(0,e._)("p",null,[h,(0,e._)("a",y,[E,(0,e.Wm)(a)]),x,w,_])]),U,(0,e._)("blockquote",null,[(0,e._)("p",null,[j,(0,e._)("a",D,[F,(0,e.Wm)(a)]),M,C,O])]),T,(0,e._)("blockquote",null,[(0,e._)("p",null,[L,(0,e._)("a",P,[W,(0,e.Wm)(a)]),R,H,S])]),(0,e._)("p",null,[N,(0,e._)("a",I,[A,(0,e.Wm)(a)]),q,(0,e._)("a",V,[K,(0,e.Wm)(a)]),z,B,Z,Y,G]),J,(0,e._)("blockquote",null,[(0,e._)("p",null,[Q,(0,e._)("a",X,[$,(0,e.Wm)(a)]),nn,sn,an])]),en,(0,e._)("ol",null,[(0,e._)("li",null,[tn,on,pn,cn,ln,rn,un,dn,kn,(0,e._)("a",mn,[vn,(0,e.Wm)(a)]),bn,fn,gn,hn]),yn,En]),xn])}]])},13860:(n,s)=>{s.Z=(n,s)=>{const a=n.__vccOpts||n;for(const[n,e]of s)a[n]=e;return a}},46915:(n,s,a)=>{a.r(s),a.d(s,{data:()=>e});const e=JSON.parse('{"key":"v-2a02618d","path":"/react/renderer/mutation.html","title":"motivation阶段","lang":"zh-CN","frontmatter":{"title":"motivation阶段","author":"BetaSu","tag":["React"],"summary":"终于到了执行DOM操作的mutation阶段。 概览 类似before mutation阶段，mutation阶段也是遍历effectList，执行函数。这里执行的是commitMutationEffects。 commitMutationEffects 代码如下： \\" 你可以在这里看到commitMutationEffects源码\\" commitMutat","head":[["meta",{"property":"og:url","content":"https://0808200.xyz/react/renderer/mutation.html"}],["meta",{"property":"og:site_name","content":"𝑀𝑟.𝐺𝑜𝑜𝑔𝑥ℎ"}],["meta",{"property":"og:title","content":"motivation阶段"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:updated_time","content":"2022-08-29T09:14:21.000Z"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"article:author","content":"BetaSu"}],["meta",{"property":"article:tag","content":"React"}],["meta",{"property":"article:modified_time","content":"2022-08-29T09:14:21.000Z"}]]},"excerpt":"","headers":[{"level":2,"title":"概览","slug":"概览","children":[]},{"level":2,"title":"commitMutationEffects","slug":"commitmutationeffects","children":[]},{"level":2,"title":"Placement effect","slug":"placement-effect","children":[]},{"level":2,"title":"Update effect","slug":"update-effect","children":[{"level":3,"title":"FunctionComponent mutation","slug":"functioncomponent-mutation","children":[]},{"level":3,"title":"HostComponent mutation","slug":"hostcomponent-mutation","children":[]}]},{"level":2,"title":"Deletion effect","slug":"deletion-effect","children":[]},{"level":2,"title":"总结","slug":"总结","children":[]}],"git":{"createdTime":1661764461000,"updatedTime":1661764461000,"contributors":[{"name":"googxh","email":"gxh522@qq.com","commits":1}]},"readingTime":{"minutes":4.16,"words":1247},"filePathRelative":"react/renderer/mutation.md","localizedDate":"2022年8月29日"}')}}]);