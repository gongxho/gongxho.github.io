"use strict";(self.webpackChunkmyblog=self.webpackChunkmyblog||[]).push([[54445],{31693:(n,s,a)=>{a.r(s),a.d(s,{default:()=>_n});var e=a(78e3);const t=(0,e.uE)('<p>ç»ˆäºåˆ°äº†æ‰§è¡Œ<code>DOM</code>æ“ä½œçš„<code>mutationé˜¶æ®µ</code>ã€‚</p><h2 id="æ¦‚è§ˆ" tabindex="-1"><a class="header-anchor" href="#æ¦‚è§ˆ" aria-hidden="true">#</a> æ¦‚è§ˆ</h2><p>ç±»ä¼¼<code>before mutationé˜¶æ®µ</code>ï¼Œ<code>mutationé˜¶æ®µ</code>ä¹Ÿæ˜¯éå†<code>effectList</code>ï¼Œæ‰§è¡Œå‡½æ•°ã€‚è¿™é‡Œæ‰§è¡Œçš„æ˜¯<code>commitMutationEffects</code>ã€‚</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>nextEffect <span class="token operator">=</span> firstEffect<span class="token punctuation">;</span>\n<span class="token keyword">do</span> <span class="token punctuation">{</span>\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n      <span class="token function">commitMutationEffects</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">invariant</span><span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&#39;Should be working on an effect.&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">captureCommitPhaseError</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="commitmutationeffects" tabindex="-1"><a class="header-anchor" href="#commitmutationeffects" aria-hidden="true">#</a> commitMutationEffects</h2><p>ä»£ç å¦‚ä¸‹ï¼š</p>',6),o=(0,e.Uk)("ä½ å¯ä»¥åœ¨"),p={href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberWorkLoop.old.js#L2091",target:"_blank",rel:"noopener noreferrer"},c=(0,e.Uk)("è¿™é‡Œ"),l=(0,e.Uk)("çœ‹åˆ°"),i=(0,e._)("code",null,"commitMutationEffects",-1),r=(0,e.Uk)("æºç "),u=(0,e.uE)('<div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">commitMutationEffects</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">root</span><span class="token operator">:</span> FiberRoot<span class="token punctuation">,</span> renderPriorityLevel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// éå†effectList</span>\n  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n\n    <span class="token keyword">const</span> effectTag <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>effectTag<span class="token punctuation">;</span>\n\n    <span class="token comment">// æ ¹æ® ContentReset effectTagé‡ç½®æ–‡å­—èŠ‚ç‚¹</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> ContentReset<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">commitResetTextContent</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// æ›´æ–°ref</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> Ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">commitDetachRef</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// æ ¹æ® effectTag åˆ†åˆ«å¤„ç†</span>\n    <span class="token keyword">const</span> primaryEffectTag <span class="token operator">=</span>\n      effectTag <span class="token operator">&amp;</span> <span class="token punctuation">(</span>Placement <span class="token operator">|</span> Update <span class="token operator">|</span> Deletion <span class="token operator">|</span> Hydrating<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">switch</span> <span class="token punctuation">(</span>primaryEffectTag<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// æ’å…¥DOM</span>\n      <span class="token keyword">case</span> <span class="token literal-property property">Placement</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token function">commitPlacement</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        nextEffect<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;=</span> <span class="token operator">~</span>Placement<span class="token punctuation">;</span>\n        <span class="token keyword">break</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// æ’å…¥DOM å¹¶ æ›´æ–°DOM</span>\n      <span class="token keyword">case</span> <span class="token literal-property property">PlacementAndUpdate</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token comment">// æ’å…¥</span>\n        <span class="token function">commitPlacement</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        nextEffect<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;=</span> <span class="token operator">~</span>Placement<span class="token punctuation">;</span>\n\n        <span class="token comment">// æ›´æ–°</span>\n        <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>\n        <span class="token function">commitWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">break</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// SSR</span>\n      <span class="token keyword">case</span> <span class="token literal-property property">Hydrating</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        nextEffect<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;=</span> <span class="token operator">~</span>Hydrating<span class="token punctuation">;</span>\n        <span class="token keyword">break</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// SSR</span>\n      <span class="token keyword">case</span> <span class="token literal-property property">HydratingAndUpdate</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        nextEffect<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;=</span> <span class="token operator">~</span>Hydrating<span class="token punctuation">;</span>\n\n        <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>\n        <span class="token function">commitWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">break</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// æ›´æ–°DOM</span>\n      <span class="token keyword">case</span> <span class="token literal-property property">Update</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>\n        <span class="token function">commitWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">break</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// åˆ é™¤DOM</span>\n      <span class="token keyword">case</span> <span class="token literal-property property">Deletion</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token function">commitDeletion</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> nextEffect<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">break</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>commitMutationEffects</code>ä¼šéå†<code>effectList</code>ï¼Œå¯¹æ¯ä¸ª<code>FiberèŠ‚ç‚¹</code>æ‰§è¡Œå¦‚ä¸‹ä¸‰ä¸ªæ“ä½œï¼š</p><ol><li>æ ¹æ®<code>ContentReset effectTag</code>é‡ç½®æ–‡å­—èŠ‚ç‚¹</li><li>æ›´æ–°<code>ref</code></li><li>æ ¹æ®<code>effectTag</code>åˆ†åˆ«å¤„ç†ï¼Œå…¶ä¸­<code>effectTag</code>åŒ…æ‹¬(<code>Placement</code> | <code>Update</code> | <code>Deletion</code> | <code>Hydrating</code>)</li></ol><p>æˆ‘ä»¬å…³æ³¨æ­¥éª¤ä¸‰ä¸­çš„<code>Placement</code> | <code>Update</code> | <code>Deletion</code>ã€‚<code>Hydrating</code>ä½œä¸ºæœåŠ¡ç«¯æ¸²æŸ“ç›¸å…³ï¼Œæˆ‘ä»¬å…ˆä¸å…³æ³¨ã€‚</p><h2 id="placement-effect" tabindex="-1"><a class="header-anchor" href="#placement-effect" aria-hidden="true">#</a> Placement effect</h2><p>å½“<code>FiberèŠ‚ç‚¹</code>å«æœ‰<code>Placement effectTag</code>ï¼Œæ„å‘³ç€è¯¥<code>FiberèŠ‚ç‚¹</code>å¯¹åº”çš„<code>DOMèŠ‚ç‚¹</code>éœ€è¦æ’å…¥åˆ°é¡µé¢ä¸­ã€‚</p><p>è°ƒç”¨çš„æ–¹æ³•ä¸º<code>commitPlacement</code>ã€‚</p>',7),d=(0,e.Uk)("ä½ å¯ä»¥åœ¨"),k={href:"https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCommitWork.new.js#L1156",target:"_blank",rel:"noopener noreferrer"},m=(0,e.Uk)("è¿™é‡Œ"),v=(0,e.Uk)("çœ‹åˆ°"),b=(0,e._)("code",null,"commitPlacement",-1),f=(0,e.Uk)("æºç "),g=(0,e.uE)('<p>è¯¥æ–¹æ³•æ‰€åšçš„å·¥ä½œåˆ†ä¸ºä¸‰æ­¥ï¼š</p><ol><li>è·å–çˆ¶çº§<code>DOMèŠ‚ç‚¹</code>ã€‚å…¶ä¸­<code>finishedWork</code>ä¸ºä¼ å…¥çš„<code>FiberèŠ‚ç‚¹</code>ã€‚</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> parentFiber <span class="token operator">=</span> <span class="token function">getHostParentFiber</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// çˆ¶çº§DOMèŠ‚ç‚¹</span>\n<span class="token keyword">const</span> parentStateNode <span class="token operator">=</span> parentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>è·å–<code>FiberèŠ‚ç‚¹</code>çš„<code>DOM</code>å…„å¼ŸèŠ‚ç‚¹</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> before <span class="token operator">=</span> <span class="token function">getHostSibling</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="3"><li>æ ¹æ®<code>DOM</code>å…„å¼ŸèŠ‚ç‚¹æ˜¯å¦å­˜åœ¨å†³å®šè°ƒç”¨<code>parentNode.insertBefore</code>æˆ–<code>parentNode.appendChild</code>æ‰§è¡Œ<code>DOM</code>æ’å…¥æ“ä½œã€‚</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// parentStateNodeæ˜¯å¦æ˜¯rootFiber</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>isContainer<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">insertOrAppendPlacementNodeIntoContainer</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">,</span> before<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n  <span class="token function">insertOrAppendPlacementNode</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">,</span> before<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ<code>getHostSibling</code>ï¼ˆè·å–å…„å¼Ÿ<code>DOMèŠ‚ç‚¹</code>ï¼‰çš„æ‰§è¡Œå¾ˆè€—æ—¶ï¼Œå½“åœ¨åŒä¸€ä¸ªçˆ¶<code>FiberèŠ‚ç‚¹</code>ä¸‹ä¾æ¬¡æ‰§è¡Œå¤šä¸ªæ’å…¥æ“ä½œï¼Œ<code>getHostSibling</code>ç®—æ³•çš„å¤æ‚åº¦ä¸ºæŒ‡æ•°çº§ã€‚</p><p>è¿™æ˜¯ç”±äº<code>FiberèŠ‚ç‚¹</code>ä¸åªåŒ…æ‹¬<code>HostComponent</code>ï¼Œæ‰€ä»¥<code>Fiberæ ‘</code>å’Œæ¸²æŸ“çš„<code>DOMæ ‘</code>èŠ‚ç‚¹å¹¶ä¸æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚è¦ä»<code>FiberèŠ‚ç‚¹</code>æ‰¾åˆ°<code>DOMèŠ‚ç‚¹</code>å¾ˆå¯èƒ½è·¨å±‚çº§éå†ã€‚</p><p>è€ƒè™‘å¦‚ä¸‹ä¾‹å­ï¼š</p><div class="language-jsx ext-jsx line-numbers-mode"><pre class="language-jsx"><code>\n<span class="token keyword">function</span> <span class="token function">Item</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">;\n}\n\nfunction App() </span><span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span></span><span class="token punctuation">/&gt;</span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>\n  <span class="token punctuation">)</span>\n<span class="token punctuation">}</span><span class="token plain-text">\n\nReactDOM.render(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">App</span></span><span class="token punctuation">/&gt;</span></span><span class="token plain-text">, document.getElementById(&#39;root&#39;));\n</span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯¹åº”çš„<code>Fiberæ ‘</code>å’Œ<code>DOMæ ‘</code>ç»“æ„ä¸ºï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// Fiberæ ‘</span>\n          child      child      child       child\nrootFiber <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span> App <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span> div <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span> Item <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span> li\n\n<span class="token comment">// DOMæ ‘</span>\n#root <span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span> div <span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span> li\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“åœ¨<code>div</code>çš„å­èŠ‚ç‚¹<code>Item</code>å‰æ’å…¥ä¸€ä¸ªæ–°èŠ‚ç‚¹<code>p</code>ï¼Œå³<code>App</code>å˜ä¸ºï¼š</p><div class="language-jsx ext-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span></span><span class="token punctuation">/&gt;</span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>\n  <span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯¹åº”çš„<code>Fiberæ ‘</code>å’Œ<code>DOMæ ‘</code>ç»“æ„ä¸ºï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// Fiberæ ‘</span>\n          child      child      child\nrootFiber <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span> App <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span> div <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span> p \n                                       <span class="token operator">|</span> sibling       child\n                                       <span class="token operator">|</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span> Item <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span> li \n<span class="token comment">// DOMæ ‘</span>\n#root <span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span> div <span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span> p\n             <span class="token operator">|</span>\n               <span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span> li\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ­¤æ—¶<code>DOMèŠ‚ç‚¹</code> <code>p</code>çš„å…„å¼ŸèŠ‚ç‚¹ä¸º<code>li</code>ï¼Œè€Œ<code>FiberèŠ‚ç‚¹</code> <code>p</code>å¯¹åº”çš„å…„å¼Ÿ<code>DOMèŠ‚ç‚¹</code>ä¸ºï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>fiberP<span class="token punctuation">.</span>sibling<span class="token punctuation">.</span>child\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å³<code>fiber p</code>çš„<code>å…„å¼Ÿfiber</code> <code>Item</code>çš„<code>å­fiber</code> <code>li</code></p><h2 id="update-effect" tabindex="-1"><a class="header-anchor" href="#update-effect" aria-hidden="true">#</a> Update effect</h2><p>å½“<code>FiberèŠ‚ç‚¹</code>å«æœ‰<code>Update effectTag</code>ï¼Œæ„å‘³ç€è¯¥<code>FiberèŠ‚ç‚¹</code>éœ€è¦æ›´æ–°ã€‚è°ƒç”¨çš„æ–¹æ³•ä¸º<code>commitWork</code>ï¼Œä»–ä¼šæ ¹æ®<code>Fiber.tag</code>åˆ†åˆ«å¤„ç†ã€‚</p>',22),h=(0,e.Uk)("ä½ å¯ä»¥åœ¨"),y={href:"https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCommitWork.new.js#L1441",target:"_blank",rel:"noopener noreferrer"},E=(0,e.Uk)("è¿™é‡Œ"),x=(0,e.Uk)("çœ‹åˆ°"),w=(0,e._)("code",null,"commitWork",-1),_=(0,e.Uk)("æºç "),U=(0,e.uE)('<p>è¿™é‡Œæˆ‘ä»¬ä¸»è¦å…³æ³¨<code>FunctionComponent</code>å’Œ<code>HostComponent</code>ã€‚</p><h3 id="functioncomponent-mutation" tabindex="-1"><a class="header-anchor" href="#functioncomponent-mutation" aria-hidden="true">#</a> FunctionComponent mutation</h3><p>å½“<code>fiber.tag</code>ä¸º<code>FunctionComponent</code>ï¼Œä¼šè°ƒç”¨<code>commitHookEffectListUnmount</code>ã€‚è¯¥æ–¹æ³•ä¼šéå†<code>effectList</code>ï¼Œæ‰§è¡Œæ‰€æœ‰<code>useLayoutEffect hook</code>çš„é”€æ¯å‡½æ•°ã€‚</p>',3),j=(0,e.Uk)("ä½ å¯ä»¥åœ¨"),D={href:"https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCommitWork.new.js#L314",target:"_blank",rel:"noopener noreferrer"},F=(0,e.Uk)("è¿™é‡Œ"),M=(0,e.Uk)("çœ‹åˆ°"),C=(0,e._)("code",null,"commitHookEffectListUnmount",-1),O=(0,e.Uk)("æºç "),T=(0,e.uE)('<p>æ‰€è°“â€œé”€æ¯å‡½æ•°â€ï¼Œè§å¦‚ä¸‹ä¾‹å­ï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">useLayoutEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...ä¸€äº›å‰¯ä½œç”¨é€»è¾‘</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    <span class="token comment">// ...è¿™å°±æ˜¯é”€æ¯å‡½æ•°</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½ ä¸éœ€è¦å¾ˆäº†è§£<code>useLayoutEffect</code>ï¼Œæˆ‘ä»¬ä¼šåœ¨ä¸‹ä¸€èŠ‚è¯¦ç»†ä»‹ç»ã€‚ä½ åªéœ€è¦çŸ¥é“åœ¨<code>mutationé˜¶æ®µ</code>ä¼šæ‰§è¡Œ<code>useLayoutEffect</code>çš„é”€æ¯å‡½æ•°ã€‚</p><h3 id="hostcomponent-mutation" tabindex="-1"><a class="header-anchor" href="#hostcomponent-mutation" aria-hidden="true">#</a> HostComponent mutation</h3><p>å½“<code>fiber.tag</code>ä¸º<code>HostComponent</code>ï¼Œä¼šè°ƒç”¨<code>commitUpdate</code>ã€‚</p>',5),L=(0,e.Uk)("ä½ å¯ä»¥åœ¨"),P={href:"https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-dom/src/client/ReactDOMHostConfig.js#L423",target:"_blank",rel:"noopener noreferrer"},W=(0,e.Uk)("è¿™é‡Œ"),R=(0,e.Uk)("çœ‹åˆ°"),H=(0,e._)("code",null,"commitUpdate",-1),S=(0,e.Uk)("æºç "),N=(0,e.Uk)("æœ€ç»ˆä¼šåœ¨"),I={href:"https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-dom/src/client/ReactDOMComponent.js#L378",target:"_blank",rel:"noopener noreferrer"},A=(0,e._)("code",null,"updateDOMProperties",-1),q=(0,e.Uk)("ä¸­å°†"),V={href:"https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCompleteWork.new.js#L229",target:"_blank",rel:"noopener noreferrer"},K=(0,e._)("code",null,"renderé˜¶æ®µ completeWork",-1),z=(0,e.Uk)("ä¸­ä¸º"),B=(0,e._)("code",null,"FiberèŠ‚ç‚¹",-1),Z=(0,e.Uk)("èµ‹å€¼çš„"),Y=(0,e._)("code",null,"updateQueue",-1),G=(0,e.Uk)("å¯¹åº”çš„å†…å®¹æ¸²æŸ“åœ¨é¡µé¢ä¸Šã€‚"),J=(0,e.uE)('<div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> updatePayload<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> propKey <span class="token operator">=</span> updatePayload<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> propValue <span class="token operator">=</span> updatePayload<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// å¤„ç† style</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">===</span> <span class="token constant">STYLE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">setValueForStyles</span><span class="token punctuation">(</span>domElement<span class="token punctuation">,</span> propValue<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// å¤„ç† DANGEROUSLY_SET_INNER_HTML</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">===</span> <span class="token constant">DANGEROUSLY_SET_INNER_HTML</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">setInnerHTML</span><span class="token punctuation">(</span>domElement<span class="token punctuation">,</span> propValue<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// å¤„ç† children</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">===</span> <span class="token constant">CHILDREN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">setTextContent</span><span class="token punctuation">(</span>domElement<span class="token punctuation">,</span> propValue<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n  <span class="token comment">// å¤„ç†å‰©ä½™ props</span>\n    <span class="token function">setValueForProperty</span><span class="token punctuation">(</span>domElement<span class="token punctuation">,</span> propKey<span class="token punctuation">,</span> propValue<span class="token punctuation">,</span> isCustomComponentTag<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="deletion-effect" tabindex="-1"><a class="header-anchor" href="#deletion-effect" aria-hidden="true">#</a> Deletion effect</h2><p>å½“<code>FiberèŠ‚ç‚¹</code>å«æœ‰<code>Deletion effectTag</code>ï¼Œæ„å‘³ç€è¯¥<code>FiberèŠ‚ç‚¹</code>å¯¹åº”çš„<code>DOMèŠ‚ç‚¹</code>éœ€è¦ä»é¡µé¢ä¸­åˆ é™¤ã€‚è°ƒç”¨çš„æ–¹æ³•ä¸º<code>commitDeletion</code>ã€‚</p>',3),Q=(0,e.Uk)("ä½ å¯ä»¥åœ¨"),X={href:"https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCommitWork.new.js#L1421",target:"_blank",rel:"noopener noreferrer"},$=(0,e.Uk)("è¿™é‡Œ"),nn=(0,e.Uk)("çœ‹åˆ°"),sn=(0,e._)("code",null,"commitDeletion",-1),an=(0,e.Uk)("æºç "),en=(0,e._)("p",null,"è¯¥æ–¹æ³•ä¼šæ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼š",-1),tn=(0,e.Uk)("é€’å½’è°ƒç”¨"),on=(0,e._)("code",null,"FiberèŠ‚ç‚¹",-1),pn=(0,e.Uk)("åŠå…¶å­å­™"),cn=(0,e._)("code",null,"FiberèŠ‚ç‚¹",-1),ln=(0,e.Uk)("ä¸­"),rn=(0,e._)("code",null,"fiber.tag",-1),un=(0,e.Uk)("ä¸º"),dn=(0,e._)("code",null,"ClassComponent",-1),kn=(0,e.Uk)("çš„"),mn={href:"https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCommitWork.new.js#L920",target:"_blank",rel:"noopener noreferrer"},vn=(0,e._)("code",null,"componentWillUnmount",-1),bn=(0,e.Uk)("ç”Ÿå‘½å‘¨æœŸé’©å­ï¼Œä»é¡µé¢ç§»é™¤"),fn=(0,e._)("code",null,"FiberèŠ‚ç‚¹",-1),gn=(0,e.Uk)("å¯¹åº”"),hn=(0,e._)("code",null,"DOMèŠ‚ç‚¹",-1),yn=(0,e._)("li",null,[(0,e.Uk)("è§£ç»‘"),(0,e._)("code",null,"ref")],-1),En=(0,e._)("li",null,[(0,e.Uk)("è°ƒåº¦"),(0,e._)("code",null,"useEffect"),(0,e.Uk)("çš„é”€æ¯å‡½æ•°")],-1),xn=(0,e.uE)('<h2 id="æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“" aria-hidden="true">#</a> æ€»ç»“</h2><p>ä»è¿™èŠ‚æˆ‘ä»¬å­¦åˆ°ï¼Œ<code>mutationé˜¶æ®µ</code>ä¼šéå†<code>effectList</code>ï¼Œä¾æ¬¡æ‰§è¡Œ<code>commitMutationEffects</code>ã€‚è¯¥æ–¹æ³•çš„ä¸»è¦å·¥ä½œä¸ºâ€œæ ¹æ®<code>effectTag</code>è°ƒç”¨ä¸åŒçš„å¤„ç†å‡½æ•°å¤„ç†<code>Fiber</code>ã€‚</p>',2),wn={},_n=(0,a(13860).Z)(wn,[["render",function(n,s){const a=(0,e.up)("ExternalLinkIcon");return(0,e.wg)(),(0,e.iD)("div",null,[t,(0,e._)("blockquote",null,[(0,e._)("p",null,[o,(0,e._)("a",p,[c,(0,e.Wm)(a)]),l,i,r])]),u,(0,e._)("blockquote",null,[(0,e._)("p",null,[d,(0,e._)("a",k,[m,(0,e.Wm)(a)]),v,b,f])]),g,(0,e._)("blockquote",null,[(0,e._)("p",null,[h,(0,e._)("a",y,[E,(0,e.Wm)(a)]),x,w,_])]),U,(0,e._)("blockquote",null,[(0,e._)("p",null,[j,(0,e._)("a",D,[F,(0,e.Wm)(a)]),M,C,O])]),T,(0,e._)("blockquote",null,[(0,e._)("p",null,[L,(0,e._)("a",P,[W,(0,e.Wm)(a)]),R,H,S])]),(0,e._)("p",null,[N,(0,e._)("a",I,[A,(0,e.Wm)(a)]),q,(0,e._)("a",V,[K,(0,e.Wm)(a)]),z,B,Z,Y,G]),J,(0,e._)("blockquote",null,[(0,e._)("p",null,[Q,(0,e._)("a",X,[$,(0,e.Wm)(a)]),nn,sn,an])]),en,(0,e._)("ol",null,[(0,e._)("li",null,[tn,on,pn,cn,ln,rn,un,dn,kn,(0,e._)("a",mn,[vn,(0,e.Wm)(a)]),bn,fn,gn,hn]),yn,En]),xn])}]])},13860:(n,s)=>{s.Z=(n,s)=>{const a=n.__vccOpts||n;for(const[n,e]of s)a[n]=e;return a}},46915:(n,s,a)=>{a.r(s),a.d(s,{data:()=>e});const e=JSON.parse('{"key":"v-2a02618d","path":"/react/renderer/mutation.html","title":"motivationé˜¶æ®µ","lang":"zh-CN","frontmatter":{"title":"motivationé˜¶æ®µ","author":"BetaSu","tag":["React"],"summary":"ç»ˆäºåˆ°äº†æ‰§è¡ŒDOMæ“ä½œçš„mutationé˜¶æ®µã€‚ æ¦‚è§ˆ ç±»ä¼¼before mutationé˜¶æ®µï¼Œmutationé˜¶æ®µä¹Ÿæ˜¯éå†effectListï¼Œæ‰§è¡Œå‡½æ•°ã€‚è¿™é‡Œæ‰§è¡Œçš„æ˜¯commitMutationEffectsã€‚ commitMutationEffects ä»£ç å¦‚ä¸‹ï¼š \\" ä½ å¯ä»¥åœ¨è¿™é‡Œçœ‹åˆ°commitMutationEffectsæºç \\" commitMutat","head":[["meta",{"property":"og:url","content":"https://0808200.xyz/react/renderer/mutation.html"}],["meta",{"property":"og:site_name","content":"ğ‘€ğ‘Ÿ.ğºğ‘œğ‘œğ‘”ğ‘¥â„"}],["meta",{"property":"og:title","content":"motivationé˜¶æ®µ"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:updated_time","content":"2022-08-29T09:14:21.000Z"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"article:author","content":"BetaSu"}],["meta",{"property":"article:tag","content":"React"}],["meta",{"property":"article:modified_time","content":"2022-08-29T09:14:21.000Z"}]]},"excerpt":"","headers":[{"level":2,"title":"æ¦‚è§ˆ","slug":"æ¦‚è§ˆ","children":[]},{"level":2,"title":"commitMutationEffects","slug":"commitmutationeffects","children":[]},{"level":2,"title":"Placement effect","slug":"placement-effect","children":[]},{"level":2,"title":"Update effect","slug":"update-effect","children":[{"level":3,"title":"FunctionComponent mutation","slug":"functioncomponent-mutation","children":[]},{"level":3,"title":"HostComponent mutation","slug":"hostcomponent-mutation","children":[]}]},{"level":2,"title":"Deletion effect","slug":"deletion-effect","children":[]},{"level":2,"title":"æ€»ç»“","slug":"æ€»ç»“","children":[]}],"git":{"createdTime":1661764461000,"updatedTime":1661764461000,"contributors":[{"name":"googxh","email":"gxh522@qq.com","commits":1}]},"readingTime":{"minutes":4.16,"words":1247},"filePathRelative":"react/renderer/mutation.md","localizedDate":"2022å¹´8æœˆ29æ—¥"}')}}]);